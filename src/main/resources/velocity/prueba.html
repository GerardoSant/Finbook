<html>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<script src="http://code.jquery.com/color/jquery.color-2.1.2.min.js"></script>


<!-- Popper JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>

<!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<style>
body {
  font-family: 'Lato', sans-serif;
}

.overlay {
  height: 100%;
  width: 0;
  position: fixed;
  z-index: 1;
  top: 0;
  left: 0;
  background-color: rgb(0,0,0);
  background-color: rgba(0,0,0, 0.9);
  overflow-x: hidden;
  transition: 0.5s;
}

.overlay-content {
  position: relative;
  top: 25%;
  width: 100%;
  text-align: center;
  margin-top: 30px;
}

.overlay a {
  padding: 8px;
  text-decoration: none;
  font-size: 36px;
  color: #818181;
  display: block;
  transition: 0.3s;
}

.overlay a:hover, .overlay a:focus {
  color: #f1f1f1;
}

.overlay .closebtn {
  position: absolute;
  top: 20px;
  right: 45px;
  font-size: 60px;
}

@media screen and (max-height: 450px) {
  .overlay a {font-size: 20px}
  .overlay .closebtn {
  font-size: 40px;
  top: 15px;
  right: 35px;
  }
}
</style>


  <head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>FinBook</title>
	<link rel="shortcut icon" href="/favicon.png" type="image/x-icon">
  </head>
  
  <nav class="navbar navbar-expand-sm" style="background-color:rgb(0,79,172)">

	<a class="nav-link" ><img src="/menu.png" alt="logo" style="height:30px" id="menuIcon" onclick="openNav()"></a>

		<!-- Brand/logo -->
	  <a class="navbar-brand" href="/index/">
		<img src="/favicon2.png" alt="logo" style="height:40px ">
	  </a>
	  
	  <span style="color:white">FinBook</span>
	  
	  <!-- Links -->
	  <ul class="navbar-nav ml-auto">
	  
		
		    <!-- Dropdown -->
		<li class="nav-item dropdown">
		  <a class="nav-link dropdown-toggle" href="#" id="navbardrop" data-toggle="dropdown">
			#if($lan== "en")
				<img src="/engLan.png" alt="logo" style="height:30px ">
			#else	
				<img src="/spaLan.png" alt="logo" style="height:30px ">
			#end	
		  </a>
		  <div class="dropdown-menu">
			<form>
				#if($lan== "en")
					<button class="dropdown-item" name="locale" value="es"><img src="/spaLan.png" alt="logo" style="height:30px "></button>
				#else
					<button class="dropdown-item" name="locale" value="en"><img src="/engLan.png" alt="logo" style="height:30px "></button>
				#end	
			</form>	
		  </div>
		</li>
		  

	  </ul>
	</nav>

  
  <body style="background-color:#F8F8F8">
  
	<div id="myNav" class="overlay">
	  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
	  <div class="overlay-content">
		<a href="/login">Login</a> 
		<a href="#">About</a>
		<a href="#">Contact</a>
	  </div>
	</div>
	  
  
    <script>
		
	

		
      function allowDrop(ev){
        ev.preventDefault();
      }
      function dropFiles(ev){
        var allXML= true;
        for (var i = 0; i < ev.dataTransfer.files.length; i += 1) {
          if (ev.dataTransfer.files[i].type!="text/xml"){
          	console.log("not XML");
			allXML=false;
          	break;
          }
        }
        if (allXML){
        	fileInput.files= ev.dataTransfer.files;
        	animateOnDrop();
        } else{
        	openModalError();
        }
        ev.preventDefault();
      }

      function openModalError(){
        document.getElementById("modalTitle").innerText=  "Error";
		document.getElementById("modalContent").innerText=  "Couldn't attach file because is not an XML file. Only XML files can be attached";
        $(document).ready(function(){
			$("#myModal").modal()
		});
        console.log("no todos son XML");
      }

	  // ANIMATIONS---------------------------------

	  function appendOnTable(filename, content, status, valid, already){
		 $(document).ready(function(){
			 if (valid){
				var popover = '<a href="#" data-toggle="popover" data-placement="bottom" data-trigger="hover" title="Upload info" data-content="'+ content + '">'+filename+'</a>'
				var append = '<tr class="table-success"><td>'+ popover+ '</td><td>'+status+'</td></tr>';
			 } else {
				var popover = '<a href="#" data-toggle="popover" data-placement="bottom" data-trigger="hover" title="Upload info" data-content="'+ content + '">'+filename+'</a>'
				if (already){
					var append = '<tr class="table-warning"><td>'+ popover+ '</td><td>'+status+'</td></tr>';
				} else{
					var append = '<tr class="table-danger"><td>'+ popover+ '</td><td>'+status+'</td></tr>';
				}

			 }
		 	$('#fileTable').find('tbody:last').append(append);
			$('[data-toggle="popover"]').popover();
		 });
	  }

      function animateOnDrop(){
      	$(document).ready(function(){
			$('#dropContainer').animate({ backgroundColor: '#add8e6'},1000);
			$('#uploadForm').animate({ borderBottomColor: '#90ee90'},1000);
			$('#dragAndDropText').animate({
				'opacity' : 0
			}, 400, function(){
				$(this).html('Files attached.<br> Press "Start Uploading" to start upload').animate({'opacity': 1}, 400);});
		});
      }

      $(document).ready(function(){
		$("#dropContainer").on("dragover",function(){
			console.log("overing");
			$(this).css('background-color', '#a9a9a9');
			//$(this).animate({ backgroundColor:  '#a9a9a9'},0);
	  	});

		$("#fileInput").on("change",function(){
			console.log("file");
			//$(this).css('background-color', '#a9a9a9');
			//$(this).animate({ backgroundColor:  '#a9a9a9'},0);
			//$(this).animate({ backgroundColor: '#90ee90'},1000);
			$('#uploadForm').animate({ borderBottomColor: '#90ee90'},1000);
			$('#dropContainer').animate({ backgroundColor: '#add8e6'},1000);
			$('#dragAndDropText').animate({
				'opacity' : 0
			}, 400, function(){
				$(this).html('Files attached.<br> Press "Start Uploading" to start upload').animate({'opacity': 1}, 400);});
			});

		$("#dropContainer").on("dragleave",function(){
			console.log("leaving");
			$(this).animate({ backgroundColor: '#FFFFFF'},0);
		});
		$("#modalClose").on("click",function(){
			console.log("modalclosed");
			$('#dropContainer').animate({ backgroundColor: '#FFFFFF'},0);
			$('#uploadForm').animate({ borderBottomColor: '#FFFFFF'},0);
			$('#dragAndDropText').animate({
				'opacity' : 0
			}, 400, function(){
				$(this).html("$msg.get("UPLOAD_DAD")").animate({'opacity': 1}, 400);});
			document.getElementById("progressdiv").style.visibility = "hidden";
			document.getElementById("fileInput").value = "";
		});

		$("#button").on("click",function(){
			$('#dropContainer').animate({ backgroundColor: '#add8e6'},0);
			$('#dragAndDropText').animate({
				'opacity' : 0
			}, 400, function(){
				$(this).html("Uploading files, please wait...").animate({'opacity': 1}, 400);});
		});
	  });
	  
	  function openNav() {
		  document.getElementById("myNav").style.width = "100%";
		}

		function closeNav() {
		  document.getElementById("myNav").style.width = "0%";	
		}


    </script>

	<div id="left" style="padding-top:50px">
	<div class ="container text-center">
      <div id="dropContainer" style="border:2px groove darkblue; background-color: white; border-radius: 5px;height:400px; display: flex;justify-content: center;
	  align-items: center;" ondragover="allowDrop(event)" ondragenter="allowDrop(event)" ondrop="dropFiles(event)">
		<img src="/bill2.png" alt="" style="height: 30%; width: 30%; object-fit: contain" />
		<br>
		<h3 id="dragAndDropText">$msg.get("UPLOAD_DAD")</h3>
      </div>
	  <br>
      <form style="border-bottom:2px groove white; border-radius: 5px" ref='uploadForm' id='uploadForm' action='upload' method='post' encType="multipart/form-data">
        <input type="file" class= "form-control-file border" name="sampleFile" id="fileInput" accept="text/xml" multiple/>
        <!--<input type='submit' value="Upload"/>-->
      </form>
      <div style="text-align: left;"><div id="progress"></div></div>

    

		<button id="button" class="btn btn-outline-primary btn-lg">Start uploading</button>
		
		<br>
		<br>
		
		<div class="progress" id="progressdiv">
			<div id="progressbar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0% height:20px">0%</div>
		</div>


		  <div class="modal fade" id="myModal">
			<div class="modal-dialog modal-dialog-centered">
			  <div class="modal-content">
			  
				<!-- Modal Header -->
				<div class="modal-header">
				  <h4 class="modal-title" id="modalTitle">Upload results info</h4>
				  <button type="button" class="close" data-dismiss="modal">×</button>
				</div>
				
				<!-- Modal body -->
				<div class="modal-body" id="modalContent">
				  Modal body..
				</div>
				
				<!-- Modal footer -->
				<div class="modal-footer">
				  <button type="button" class="btn btn-danger" data-dismiss="modal" id="modalClose">OK</button>
				</div>
				
			  </div>
			</div>
		  </div>
		</div>
	</div>

	<div class="container" id="right" style="float:right ; width:40% ; padding-top:50px">
		<h2>File uploads <span class="badge badge-success">
		<a id="fileUploadsNum" href="#" title=" New files uploaded" data-toggle="popover" data-trigger="hover" data-content="Hover over filename to check upload info" style="color:white"></a></span></h2>
		<table class="table" id ="fileTable" style = "overflow-y:scroll;height:70%;display:block">
			<thead class="thead-dark">
			<tr>
				<th>Bill name</th>
				<th>Status</th>
			</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
	</div>

    <script>

    //float:left ; width:50% ; padding-top:50px
	
	  
	
	  function initInterface(){
	    document.getElementById("progressdiv").style.visibility = "hidden";
		document.getElementById("right").style.visibility = "hidden";
	    $(document).ready(function(){
		  $("#right").hide(1000);
	    });
	  }
	  
	  initInterface();
	  
	  function doFirstUploadInterfaceTransition(){
		document.getElementById("left").style.float = "left";
		document.getElementById("left").style.width = "100%";
		document.getElementById("left").style.paddingTop = "50px";
		document.getElementById("left").style.paddingLeft = "50px";
		document.getElementById("right").style.paddingRight = "50px";
	  	document.getElementById("right").style.visibility = "visible";
		$(document).ready(function(){
			$("#right").show(1000);
		});

		$(document).ready(function(){
			$("#left").animate({width: "50%"},1000)
		});
	  }
	  
	  
	  function splitResponseText(responseText){
		var res= responseText.split('||');
		var fixedString="";
		for (var i=0; i<res.length; i++){
			fixedString+=res[i]+"\n";
		}
		return fixedString;
	  }
	  
	  
	  var loadBtn = document.getElementById("button");
      
	  var initInterface=true;

      function upload(data) {
		document.getElementById("progressdiv").style.visibility = "visible";
        
		var xhr = new XMLHttpRequest();
        xhr.open("POST", "/upload", true);
        if (xhr.upload) {
          xhr.upload.onprogress = function(e) {
            if (e.lengthComputable) {
              
			  document.getElementById("progressbar").style.width = ((e.loaded / e.total) * 100)+"%";
			  document.getElementById("progressbar").innerHTML=Math.round(((e.loaded / e.total) * 100))+"%";
            }
          }
          xhr.upload.onloadstart = function(e) {
			  document.getElementById("progressbar").style.width = 0+"%";
			  document.getElementById("progressbar").innerHTML=0+"%";
          }
          xhr.upload.onloadend = function(e) {
            loadBtn.disabled = false;
            loadBtn.innerHTML = 'Start uploading';
			document.getElementById("progressbar").innerHTML="Completed";
          }
          xhr.onreadystatechange = function(){
            if (this.readyState == 4){
              console.log("im here");
              console.log(this.responseText);
			  	  $(document).ready(function(){
					  $("#myModal").modal()
				  });
			  if(initInterface){
				doFirstUploadInterfaceTransition();
				initInterface=false;
			  }
			  processResponseText(this.responseText);
			  document.getElementById("modalContent").innerText=  splitResponseText(this.responseText);
            }
          }
        }


        xhr.send(data);
      }

      function buildFormData() {
        var fd = new FormData();

        for (var i = 0; i < fileInput.files.length; i += 1) {
          fd.append("sampleFile",fileInput.files[i]);
        }

        return fd;
      }

      loadBtn.addEventListener("click", function(e) {
        this.disabled = true;
        this.innerHTML = "Uploading...";
        upload(buildFormData());
      });

      function processResponseText(responseText){
      	var responses = responseText.split('|');
		addBadgeUploadInfo(responses);
      	for (var i=0; i<responses.length; i++){
			var responseSplit = responses[i].split(":");
			console.log(responseSplit[0]);
			console.log(responseSplit[1]);
			if(responseSplit[1]=='Yes'){
				appendOnTable(responseSplit[0], "Uploaded succesfully", "Uploaded", true, true);
			}
			if(responseSplit[1]=='Already'){
				appendOnTable(responseSplit[0], "Bill already in database", "Already", false, true);
			}
			if(responseSplit[1]=='Invalid'){
				appendOnTable(responseSplit[0], "Bill hasn't got a valid signature", "Invalid", false);
			}

      	}
      }
	  
	  function addBadgeUploadInfo(response){
		var uploads= response.length;
		document.getElementById("fileUploadsNum").title= uploads + " files uploaded";
		document.getElementById("fileUploadsNum").innerHTML=uploads;		
	  }
	  

      $(document).ready(function(){
  		$('[data-toggle="popover"]').popover();
	  });
	  


    </script>

  </div>
  </body>
  


  
  <footer class="page-footer font-small blue" style="  position: absolute;
  bottom: 0;
  width: 100%;
  height: 2.5rem;
  padding-bottom: 50px;">

	  <!-- Copyright -->
	  <div class="footer-copyright text-center py-3">© 2019 Copyright:
		<a href="finbook.io"> FinBook</a>
		<img src="/favicon.png" alt="" style="height: 2.5%; width: 2.5%; object-fit: contain" />
	  </div>
	  <!-- Copyright -->

  </footer>
  

  
</html>